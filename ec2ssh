#!/bin/bash

# List all servers and parse the ec2din output to a digest
ec2din | awk '
	BEGIN {
		FS="\t";
		printf "%4s\t%10s\t%10s\t%-40s\t%s\n", "No.", "Instance", "Sec. group", "Domain name", "Tag";
	}
	
	/INSTANCE/ {
		counter++;
		inst=$2;
		domain=$4;
		sg=$29;
	}
	
	/TAG/ {
		if ( $4 == "Name") {
			tag=$5;
			getline;
		} else {
			b="NULL";
		}
		
		printf "%4s\t%10s\t%10s\t%-40s\t%s\n", counter, inst,sg,domain,tag;
	}
' > /tmp/server_list

# Check if parameter present. If so, match the lines.
if [[ $# -eq 1 ]]
then
	cat /tmp/server_list | grep -i $1
else
	cat /tmp/server_list
fi

read -p 'Enter server number, server range (e.g. 3..5) or list of servers (e.g. 2 3 4 8 9): ' servers

if [[ $servers =~ ([0-9]+)..([0-9]+) ]]
then
	start=${BASH_REMATCH[1]}
	end=${BASH_REMATCH[2]}
	servers=$(seq $start $end)
fi

for server in $servers
do
	domain=$(awk "NR==$server+1" /tmp/server_list | awk "{print \$4}")

	echo "Ssh-ing to $domain"

	ssh $domain
done
